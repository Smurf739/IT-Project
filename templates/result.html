{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-bar"></i> Результаты анализа</h2>
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left"></i> Новый анализ
            </a>
        </div>

        {% if error %}
        <div class="alert alert-danger">
            <h4><i class="fas fa-exclamation-triangle"></i> Ошибка анализа</h4>
            <p>Не удалось проанализировать сайт: {{ url }}</p>
            <p>Проверьте правильность URL и доступность сайта.</p>
        </div>
        {% else %}
        
        <!-- Основная информация -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Основная информация</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>URL:</strong> {{ results.url }}</p>
                        <p><strong>Время загрузки:</strong> {{ results.load_time }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Статус анализа:</strong> <span class="badge bg-success">Завершен</span></p>
                    </div>
                </div>
            </div>
        </div>


        <div class="card mb-4 border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Общая оценка и шансы в генеративном поиске
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Основной балл -->
                    <div class="col-md-4 text-center mb-4">
                        <div class="display-1 fw-bold text-{{ 'success' if results.overall_analysis.overall_score >= 70 else 'warning' if results.overall_analysis.overall_score >= 50 else 'danger' }}">
                            {{ results.overall_analysis.overall_score }}%
                        </div>
                        <div class="h5 text-muted">Общий балл</div>
                        <div class="small text-muted mt-2">
                            {{ results.overall_analysis.description }}
                        </div>
                    </div>

                    <!-- Шансы в генеративном поиске -->
                    <div class="col-md-4 text-center mb-4">
                        <div class="h2 fw-bold text-{{ 'success' if results.overall_analysis.gen_ai_chance in ['Очень высокий', 'Высокий'] else 'warning' if results.overall_analysis.gen_ai_chance == 'Хороший' else 'danger' }}">
                            {{ results.overall_analysis.gen_ai_chance }}
                        </div>
                        <div class="h5 text-muted">Шанс в AI-поиске</div>
                        <div class="small text-muted mt-2">
                            Вероятность: {{ results.overall_analysis.chance_percentage }}
                        </div>
                    </div>

                    <!-- Факторы оптимизации -->
                    <div class="col-md-4 text-center mb-4">
                        <div class="h2 fw-bold text-info">
                            {{ results.overall_analysis.positive_factors }}/{{ results.overall_analysis.total_factors }}
                        </div>
                        <div class="h5 text-muted">Ключевые факторы</div>
                        <div class="small text-muted mt-2">
                            Положительные показатели
                        </div>
                    </div>
                </div>

                <!-- Детализация по категориям -->
                <div class="mt-4">
                    <h6 class="text-center mb-3">
                        <i class="fas fa-chart-bar me-2"></i>Детализация по категориям
                    </h6>
                    <div class="row">
                        {% for category, score in results.overall_analysis.category_scores.items() %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="small">{{ category }}</span>
                                <div class="d-flex align-items-center">
                                    <div class="progress" style="width: 100px; height: 8px;">
                                        <div class="progress-bar bg-{{ 'success' if score >= 70 else 'warning' if score >= 50 else 'danger' }}"
                                             style="width: {{ score }}%"></div>
                                    </div>
                                    <span class="small ms-2 fw-bold">{{ score }}%</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Сильные и слабые стороны -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-thumbs-up me-2"></i>Сильные стороны
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if results.overall_analysis.strengths %}
                                    {% for strength in results.overall_analysis.strengths %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        <span class="small">{{ strength }}</span>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted small mb-0">Сильные стороны не выявлены</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-danger h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-thumbs-down me-2"></i>Слабые стороны
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if results.overall_analysis.weaknesses %}
                                    {% for weakness in results.overall_analysis.weaknesses %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-exclamation text-danger me-2"></i>
                                        <span class="small">{{ weakness }}</span>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted small mb-0">Слабые стороны не выявлены</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Рекомендации для улучшения -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-3">
                        <i class="fas fa-bullseye me-2"></i>Стратегия улучшения
                    </h6>
                    {% if results.overall_analysis.overall_score >= 80 %}
                    <p class="small text-success mb-2">
                        <i class="fas fa-trophy me-2"></i>
                        <strong>Отличный результат!</strong> Сайт хорошо оптимизирован.
                        Сосредоточьтесь на поддержании текущих показателей и постепенном улучшении.
                    </p>
                    {% elif results.overall_analysis.overall_score >= 60 %}
                    <p class="small text-warning mb-2">
                        <i class="fas fa-chart-line me-2"></i>
                        <strong>Хороший потенциал!</strong> Сайт имеет прочную основу.
                        Устраните основные слабые стороны для значительного улучшения позиций.
                    </p>
                    {% else %}
                    <p class="small text-danger mb-2">
                        <i class="fas fa-tools me-2"></i>
                        <strong>Требуется оптимизация!</strong> Начните с исправления критических ошибок
                        и улучшения технических показателей.
                    </p>
                    {% endif %}

                    <div class="small text-muted">
                        <strong>Приоритеты:</strong>
                        {% if results.overall_analysis.overall_score < 60 %}
                        Техническая оптимизация → Семантика → Контент → Авторитетность
                        {% elif results.overall_analysis.overall_score < 80 %}
                        Качество контента → LLM-оптимизация → Авторитетность
                        {% else %}
                        Поддержание качества → Улучшение пользовательского опыта
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

                <!-- В result.html замените блок рекомендаций на этот код -->
        <!-- В result.html замените блок рекомендаций на этот код -->
{% if results.recommendations %}
<div class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
            <i class="fas fa-robot me-2"></i>Умные рекомендации от AI
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <strong>
                <i class="fas fa-magic me-2"></i>
                Найдено {{ results.recommendations|length }} рекомендаций с AI-исправлениями
            </strong>
        </div>

        {% for rec in results.recommendations %}
        <div class="recommendation-item mb-4 p-3 border rounded">
            <!-- Верхняя часть с информацией о проблеме -->
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="{{ 'text-danger' if rec.type == 'critical' else 'text-warning' if rec.type == 'warning' else 'text-info' }}">
                    <i class="fas fa-{{ 'exclamation-triangle' if rec.type == 'critical' else 'exclamation-circle' if rec.type == 'warning' else 'info-circle' }} me-2"></i>
                    {{ rec.title }}
                </h6>
                <div class="d-flex flex-wrap gap-1">
                    <span class="badge bg-{{ 'danger' if rec.type == 'critical' else 'warning' if rec.type == 'warning' else 'info' }}">
                        {{ rec.type }}
                    </span>
                    {% if rec.gpt_error %}
                    <span class="badge bg-secondary">AI: Ошибка</span>
                    {% else %}
                    <span class="badge bg-success">AI: Исправлено</span>
                    {% endif %}
                </div>
            </div>

            <!-- Описание проблемы -->
            <p class="text-muted mb-3">{{ rec.message }}</p>

            <!-- Список изменений (если есть) -->
            {% if rec.changes and rec.changes|length > 0 %}
            <div class="mb-3">
                <h6 class="text-primary">
                    <i class="fas fa-list me-2"></i>Что было изменено AI:
                </h6>
                <ul class="list-group list-group-flush">
                    {% for change in rec.changes %}
                    <li class="list-group-item d-flex align-items-center py-2">
                        <i class="fas fa-arrow-right text-success me-2 small"></i>
                        <span class="small">{{ change }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Объяснение AI -->
            <div class="mb-3 p-3 bg-light rounded">
                <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle text-info mt-1 me-2"></i>
                    <div>
                        <strong class="small">Объяснение AI:</strong>
                        <p class="small text-muted mb-0">{{ rec.explanation }}</p>
                    </div>
                </div>
            </div>

            <!-- Блоки кода внизу - ВЕРТИКАЛЬНО друг за другом -->
            <div class="mt-4 pt-3 border-top">
                <h6 class="text-muted mb-3">
                    <i class="fas fa-code me-2"></i>Сравнение кода:
                </h6>

                <!-- Текущий код -->
                <div class="mb-4">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-times me-2"></i>Текущий код:
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <pre class="mb-0"><code class="language-html small">{{ rec.current_code }}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Исправленный код AI -->
                <div class="mb-2">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-check me-2"></i>Исправленный код AI:
                            </h6>
                        </div>
                        <div class="card-body p-2">
                            <pre class="mb-0"><code class="language-html small">{{ rec.fixed_code }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ошибка AI (если есть) -->
            {% if rec.gpt_error %}
            <div class="mt-3 p-3 bg-danger text-white rounded">
                <div class="d-flex align-items-start">
                    <i class="fas fa-exclamation-triangle mt-1 me-2"></i>
                    <div>
                        <strong class="small">Ошибка AI:</strong>
                        <p class="small mb-0">{{ rec.gpt_error }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if not loop.last %}
        <hr class="my-4">
        {% endif %}

        {% endfor %}
    </div>
</div>
{% endif %}

        <!-- Детальные результаты -->
        <div class="row">
            <!-- Семантика -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-tags"></i> Семантика</h6>
                    </div>
                    <div class="card-body">
                        {% set s = results.semantic_clarity %}
                        <p><strong>Title:</strong> {{ s.title|default('Не найден', true) }}</p>
                        <p><strong>Длина Title:</strong> 
                            <span class="badge {{ 'bg-success' if s.title_optimal else 'bg-danger' }}">
                                {{ s.title_length }} символов
                            </span>
                        </p>
                        <p><strong>Description:</strong> {{ s.description|default('Не найден', true) }}</p>
                        <p><strong>Длина Description:</strong> 
                            <span class="badge {{ 'bg-success' if s.description_optimal else 'bg-danger' }}">
                                {{ s.description_length }} символов
                            </span>
                        </p>
                        <p><strong>H1:</strong> {{ s.h1|default('Не найден', true) }}</p>
                        <p><strong>Title/H1 совпадение:</strong> 
                            <span class="badge {{ 'bg-success' if s.title_h1_match else 'bg-danger' }}">
                                {{ 'Да' if s.title_h1_match else 'Нет' }}
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Заголовки -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-heading"></i> Заголовки</h6>
                    </div>
                    <div class="card-body">
                        {% set h = results.headers %}
                        <p><strong>H1:</strong> 
                            <span class="badge {{ 'bg-success' if h.h1_optimal else 'bg-danger' }}">
                                {{ h.h1_count }}
                            </span>
                        </p>
                        <p><strong>H2:</strong> <span class="badge bg-info">{{ h.h2_count }}</span></p>
                        <p><strong>H3:</strong> <span class="badge bg-info">{{ h.h3_count }}</span></p>
                        {% if h.h1_examples %}
                        <p><strong>Примеры H1:</strong></p>
                        <ul>
                            {% for example in h.h1_examples %}
                            <li>{{ example }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Структура -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-sitemap"></i> Структура</h6>
                    </div>
                    <div class="card-body">
                        {% set st = results.structure %}
                        <p><strong>Списки:</strong> <span class="badge bg-info">{{ st.lists }}</span></p>
                        <p><strong>Таблицы:</strong> <span class="badge bg-info">{{ st.tables }}</span></p>
                        <p><strong>Блоки/цитаты:</strong> <span class="badge bg-info">{{ st.blockquotes }}</span></p>
                        <p><strong>Схемы/диаграммы:</strong> <span class="badge bg-info">{{ st.schemes }}</span></p>
                    </div>
                </div>
            </div>

            <!-- Вопросы -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-question-circle"></i> Вопросы</h6>
                    </div>
                    <div class="card-body">
                        {% set q = results.questions %}
                        <p><strong>Найдено вопросов:</strong> <span class="badge bg-info">{{ q.count }}</span></p>
                        {% if q.examples %}
                        <p><strong>Примеры:</strong></p>
                        <ul>
                            {% for example in q.examples %}
                            <li>{{ example[:100] }}{% if example|length > 100 %}...{% endif %}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Структурированные данные -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-database"></i> Структурированные данные</h6>
                    </div>
                    <div class="card-body">
                        {% set sd = results.structured_data %}
                        <p><strong>JSON-LD:</strong> 
                            <span class="badge {{ 'bg-success' if sd.json_ld > 0 else 'bg-danger' }}">
                                {{ sd.json_ld }} блоков
                            </span>
                        </p>
                        <p><strong>Open Graph:</strong> <span class="badge bg-info">{{ sd.og_tags }} тегов</span></p>
                        {% if sd.json_ld_types %}
                        <p><strong>Типы Schema.org:</strong></p>
                        <ul>
                            {% for type in sd.json_ld_types %}
                            <li>{{ type }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- EEAT -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6><i class="fas fa-shield-alt"></i> Авторитетность (EEAT)</h6>
                    </div>
                    <div class="card-body">
                        {% set e = results.eeat %}
                        <p><strong>HTTPS:</strong> 
                            <span class="badge {{ 'bg-success' if e.https else 'bg-danger' }}">
                                {{ 'Да' if e.https else 'Нет' }}
                            </span>
                        </p>
                        <p><strong>Контакты:</strong> 
                            <span class="badge {{ 'bg-success' if e.contact_info else 'bg-warning' }}">
                                {{ 'Да' if e.contact_info else 'Нет' }}
                            </span>
                        </p>
                        <p><strong>О компании:</strong> 
                            <span class="badge {{ 'bg-success' if e.about_page else 'bg-warning' }}">
                                {{ 'Да' if e.about_page else 'Нет' }}
                            </span>
                        </p>
                        <p><strong>Авторитетные ссылки:</strong> <span class="badge bg-info">{{ e.authoritative_links }}</span></p>
                        <p><strong>Оценка EEAT:</strong> 
                            <span class="badge {{ 'bg-success' if e.eeat_score >= 3 else 'bg-warning' }}">
                                {{ e.eeat_score }}/5
                            </span>
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Критические ошибки -->
        {% if results.validation.issues %}
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Критические ошибки</h5>
            </div>
            <div class="card-body">
                {% for issue in results.validation.issues %}
                <div class="critical-issue">
                    <i class="fas fa-times-circle text-danger me-2"></i>{{ issue }}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% endif %}
    </div>
</div>
{% endblock %}